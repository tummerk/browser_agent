# Руководство по диагностике и устранению неполадок Browser Agent

## Общие проблемы и симптомы

### Типичные симптомы неправильной работы:
- Агент зацикливается, повторяя одни и те же действия
- Агент не может выполнить простые задачи (например, перейти по URL или кликнуть по элементу)
- Агент игнорирует элементы на странице
- Агент не реагирует на изменения на странице после действий
- Агент завершает задачу слишком рано или не завершает её никогда

## План диагностики

### 1. Проверка базовой функциональности браузера

#### 1.1. Запуск браузера
- Убедитесь, что браузер запускается без ошибок
- Проверьте, что используется правильный путь к `user_data` каталогу
- Убедитесь, что браузер не блокируется антивирусом или фаерволом

#### 1.2. Навигация по страницам
- Проверьте, может ли агент перейти на простую страницу (например, https://example.com)
- Убедитесь, что страница полностью загружается перед выполнением действий
- Проверьте, что агент может получить информацию о текущей странице (URL, заголовок)

#### 1.3. Взаимодействие с DOM
- Проверьте, может ли агент получить DOM-представление страницы
- Убедитесь, что элементы правильно отображаются в DOM Summary
- Проверьте, что элементы имеют корректные ID и текстовые описания

### 2. Проверка работы сканера DOM

#### 2.1. Анализ скрипта `ObserveElementsScript`
- Убедитесь, что скрипт корректно находит элементы на странице
- Проверьте, что скрипт не пропускает важные элементы
- Убедитесь, что скрипт корректно определяет состояния элементов (checked, active, disabled и т.д.)

#### 2.2. Фильтрация элементов
- Проверьте, что скрипт не отфильтровывает важные элементы
- Убедитесь, что на странице отображаются элементы с интерактивными тегами (button, a, input и т.д.)
- Проверьте, что текстовые элементы (h1, h2, p) также отображаются при необходимости

#### 2.3. Присвоение ID элементам
- Убедитесь, что каждый элемент получает уникальный ID
- Проверьте, что элементы с ID корректно сохраняются в `ElementMap`
- Убедитесь, что при переходе на новую страницу ID обновляются

### 3. Проверка работы LLM клиента

#### 3.1. Отправка промптов
- Проверьте, что системный промпт `ActorPrompt` корректно передается LLM
- Убедитесь, что пользовательский промпт формируется правильно с учетом задачи, истории и текущего состояния
- Проверьте, что история действий ограничивается последними 7 действиями

#### 3.2. Обработка ответов LLM
- Убедитесь, что ответы LLM корректно парсятся в `ToolCall`
- Проверьте, что аргументы инструментов корректно извлекаются
- Убедитесь, что обоснования (reasoning) корректно извлекаются

#### 3.3. Повторные попытки
- Проверьте, что при ошибках API делаются повторные попытки (до 3 раз)
- Убедитесь, что таймауты корректно установлены (30 секунд на запрос)

### 4. Проверка работы оркестратора

#### 4.1. Цикл ReAct
- Убедитесь, что цикл ReAct корректно работает: Observe → Think → Act
- Проверьте, что максимальное количество шагов (50) не превышается преждевременно
- Убедитесь, что при достижении лимита шагов происходит корректная остановка

#### 4.2. Обнаружение зацикливания
- Проверьте, что система обнаружения зацикливания работает корректно
- Убедитесь, что при повторении одного и того же действия 3 раза агент получает сообщение об ошибке
- Проверьте, что сигнатура действия учитывает все параметры кроме reasoning

#### 4.3. Выполнение инструментов
- Убедитесь, что все инструменты корректно реализованы и работают
- Проверьте, что аргументы инструментов корректно передаются
- Убедитесь, что результаты выполнения инструментов корректно регистрируются в истории

### 5. Проверка конкретных инструментов

#### 5.1. Инструмент `click`
- Проверьте, что элемент с указанным ID существует в `ElementMap`
- Убедитесь, что клик действительно происходит (визуальная обратная связь)
- Проверьте, что после клика страница корректно обновляется (если требуется)

#### 5.2. Инструмент `type_text`
- Убедитесь, что текст корректно вводится в поле
- Проверьте, что поле действительно получает фокус
- Убедитесь, что после ввода в поисковое поле вызывается `press_enter`

#### 5.3. Инструмент `go_to_url`
- Проверьте, что URL корректно формируется (добавляется https:// при необходимости)
- Убедитесь, что страница полностью загружается после перехода
- Проверьте, что DOM обновляется после перехода

#### 5.4. Инструмент `scroll_down`
- Убедитесь, что страница действительно прокручивается
- Проверьте, что после прокрутки DOM обновляется и показывает новые элементы

#### 5.5. Инструмент `done`
- Убедитесь, что задача действительно завершается при вызове этого инструмента
- Проверьте, что результат корректно возвращается

### 6. Проверка логов и отладочной информации

#### 6.1. Уровень логирования
- Убедитесь, что все важные события логируются
- Проверьте, что логи содержат достаточно информации для диагностики
- Убедитесь, что логи показывают последовательность действий агента

#### 6.2. Отладка DOM
- Проверьте, что DOM Summary корректно отображает элементы
- Убедитесь, что ID элементов совпадают между DOM и тем, что использует агент
- Проверьте, что текстовые описания элементов понятны для LLM

#### 6.3. История действий
- Убедитесь, что история действий корректно сохраняется и передается LLM
- Проверьте, что в истории отображаются обоснования, действия, аргументы и результаты

## Методы тестирования

### 1. Тестирование на простых задачах
1. **Открытие URL**: Попросите агента перейти на простой сайт (например, https://example.com)
2. **Поиск текста**: Попросите агента найти и вывести определенный текст на странице
3. **Клик по элементу**: Попросите агента кликнуть по конкретной ссылке или кнопке
4. **Ввод текста**: Попросите агента ввести текст в поле ввода

### 2. Тестирование на многошаговых задачах
1. **Поиск и клик**: Попросите агента найти элемент и кликнуть по нему
2. **Поиск информации**: Попросите агента найти и вывести определенную информацию со страницы
3. **Навигация**: Попросите агента перейти с одной страницы на другую и выполнить действие

### 3. Тестирование обработки ошибок
1. **Несуществующий элемент**: Попробуйте кликнуть по элементу, которого нет на странице
2. **Неправильный URL**: Попробуйте перейти по неправильному URL
3. **Таймауты**: Проверьте, как агент реагирует на медленно загружающиеся страницы

## Типичные причины проблем

### 1. Проблемы с DOM сканированием
- Скрипт не находит элементы из-за медленной загрузки страницы
- Элементы не видны из-за прокрутки или скрытия
- Элементы динамически создаются после начальной загрузки

### 2. Проблемы с LLM
- Неправильно сформированный промпт
- LLM не понимает структуру DOM
- LLM не следует инструкциям

### 3. Проблемы с браузером
- Страница не полностью загружена перед выполнением действий
- Элементы не готовы к взаимодействию
- Защита сайта от автоматизации

### 4. Проблемы с логикой агента
- Неправильное определение завершения задачи
- Недостаточная проверка условий для зацикливания
- Ошибки в обработке состояний элементов

## Рекомендации по улучшению

### 1. Улучшение сканирования DOM
- Добавьте ожидание стабильности страницы перед сканированием
- Увеличьте таймауты при сканировании сложных страниц
- Добавьте повторные попытки при ошибках сканирования

### 2. Улучшение взаимодействия с LLM
- Уточните инструкции в системном промпте
- Добавьте больше примеров в промпт
- Улучшите форматирование DOM для лучшего понимания LLM

### 3. Улучшение обнаружения зацикливания
- Добавьте более сложную логику обнаружения зацикливания
- Увеличьте разнообразие действий при обнаружении зацикливания
- Добавьте возможность "отката" к предыдущему состоянию

### 4. Улучшение обработки ошибок
- Добавьте более подробную обработку ошибок для каждого инструмента
- Реализуйте стратегии восстановления после ошибок
- Добавьте логирование ошибок для диагностики

## Проверочный чек-лист

- [ ] Браузер успешно запускается
- [ ] Страницы успешно загружаются
- [ ] DOM корректно сканируется
- [ ] Элементы имеют корректные ID
- [ ] LLM получает корректные промпты
- [ ] Ответы LLM корректно парсятся
- [ ] Инструменты корректно выполняются
- [ ] История действий корректно сохраняется
- [ ] Зацикливание корректно обнаруживается
- [ ] Агент может выполнить простые задачи
- [ ] Агент корректно завершает задачи
- [ ] Логи содержат достаточную информацию для диагностики